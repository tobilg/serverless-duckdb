service: serverless-duckdb

frameworkVersion: '3'

plugins:
  - serverless-iam-roles-per-function
  - serverless-prune-plugin
  - serverless-esbuild

custom:

  # API details
  api:
    version: 'v1'
  
  # esbuild plugin
  esbuild:
    bundle: true
    minify: false
    exclude:
      - 'duckdb'
      - 'aws-lambda'
      - 'dtrace-provider'

  # Prune plugin
  prune:
    automatic: true
    number: 3

provider:
  name: aws
  runtime: nodejs16.x
  region: ${opt:region, 'us-east-1'}
  stage: 'prd'
  logRetentionInDays: 14
  apiGateway:
    apiKeys:
      - DuckDBKey
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1' # Enable HTTP keep-alive connections for the AWS SDK
    STAGE: '${self:provider.stage}'
    LOG_LEVEL: 'debug'

functions:

  # Streaming Lambda function: Will return results as Apache Arrow IPC stream
  streamingQuery:
    handler: src/functions/streamingQuery.handler
    memorySize: 2048
    timeout: 30
    url:
      invokeMode: RESPONSE_STREAM
    layers:
      # Latest x86 layer
      - 'arn:aws:lambda:${self:provider.region}:041475135427:layer:duckdb-nodejs-x86:7'

  # Request-Response Lambda function: Will return results as JSON en bloc
  query:
    handler: src/functions/query.handler
    memorySize: 2048
    timeout: 30
    # Enable this for arm64 support
    # architecture: arm64
    # Enable this for custom IAM roles for S3 access
    # iamRoleStatements:
    #   # Read from input bucket
    #   - Effect: Allow
    #     Action:
    #       - s3:GetObject
    #     Resource: 'arn:aws:s3:::YOUR-S3-INPUT-BUCKET-NAME/*'
    #   - Effect: Allow
    #     Action:
    #       - s3:ListBucket
    #     Resource: 'arn:aws:s3:::YOUR-S3-INPUT-BUCKET-NAME'
    #   # If you want to write to another output bucket, use the statements below
    #   # (or use the same bucket name as the input bucket if you want to write to it as well)
    #   - Effect: Allow
    #     Action:
    #       - s3:ListBucket
    #       - s3:ListBucketMultipartUploads
    #     Resource: 'arn:aws:s3:::YOUR-S3-OUTPUT-BUCKET-NAME'
    #   - Effect: Allow
    #     Action:
    #       - s3:GetObject
    #       - s3:PutObject
    #       - s3:AbortMultipartUpload
    #       - s3:ListMultipartUploadParts
    #     Resource: 'arn:aws:s3:::YOUR-S3-OUTPUT-BUCKET-NAME/*'
    layers:
      # Latest x86_64 layer
      - 'arn:aws:lambda:${self:provider.region}:041475135427:layer:duckdb-nodejs-x86:7'
      # Latest arm64 layer
      # - 'arn:aws:lambda:${self:provider.region}:041475135427:layer:duckdb-nodejs-arm64:5'
      # Latest x86_64 layer containing the spatial extension 
      # - arn:aws:lambda:${self:provider.region}:041475135427:layer:duckdb-nodejs-spatial-x86:2
    events:
      - http:
          path: ${self:custom.api.version}/query
          method: post
          cors: true
          private: true

package:
  individually: true
